<div class="task-list-container">
  <!-- Loading Progress Bar -->
  <mat-progress-bar *ngIf="isLoading" mode="indeterminate" class="loading-bar"></mat-progress-bar>

  <div class="task-list-header">
    <h2>Task List</h2>
    <div class="header-controls">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search tasks</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Search by title..." autocomplete="off">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
      
      <!-- Mobile Sort Button -->
      <button mat-icon-button [matMenuTriggerFor]="mobileSortMenu" class="mobile-sort-button">
        <mat-icon>sort</mat-icon>
      </button>
      <mat-menu #mobileSortMenu="matMenu">
        <button mat-menu-item (click)="loadAllTasks()">
          <mat-icon>list</mat-icon>
          All Tasks
        </button>
        <button mat-menu-item (click)="loadTasksDueInNext7Days()">
          <mat-icon>schedule</mat-icon>
          Due in Next 7 Days
        </button>
        <button mat-menu-item (click)="loadOverdueTasks()">
          <mat-icon>warning</mat-icon>
          Overdue Tasks
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="sortByPriority('high')">
          <mat-icon>priority_high</mat-icon>
          Priority: High to Low
        </button>
        <button mat-menu-item (click)="sortByPriority('low')">
          <mat-icon>priority_low</mat-icon>
          Priority: Low to High
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Bulk Action Bar -->
  <div *ngIf="getSelectedTasksCount() > 0" class="bulk-action-bar">
    <div class="bulk-action-info">
      <mat-icon>check_circle</mat-icon>
      <span>{{ getSelectedTasksCount() }} task(s) selected</span>
    </div>
    <div class="bulk-action-buttons">
      <button mat-button color="primary" (click)="openBulkUpdateStatusDialog()">
        <mat-icon>update</mat-icon>
        Update Status
      </button>
    </div>
  </div>

  <!-- Desktop Table Layout -->
  <table mat-table [dataSource]="dataSource" matSort>
    <!-- Checkbox Column -->
    <ng-container matColumnDef="select">
      <th mat-header-cell *matHeaderCellDef>
        <mat-checkbox
          (change)="$event ? masterToggle() : null"
          [checked]="isAllSelected()"
          [indeterminate]="isIndeterminate()"
          [disabled]="tasks.length === 0">
        </mat-checkbox>
      </th>
      <td mat-cell *matCellDef="let task">
        <mat-checkbox
          (click)="$event.stopPropagation()"
          (change)="$event ? toggleTaskSelection(task.id) : null"
          [checked]="isTaskSelected(task.id)">
        </mat-checkbox>
      </td>
    </ng-container>

    <ng-container matColumnDef="title">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Title</th>
      <td mat-cell *matCellDef="let task">{{task.title}}</td>
    </ng-container>
    <ng-container matColumnDef="dueDate">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Due Date</th>
      <td mat-cell *matCellDef="let task">{{task.dueDate | date}}</td>
    </ng-container>
    <ng-container matColumnDef="priority">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Priority</th>
      <td mat-cell *matCellDef="let task">
        <span class="priority-badge" [ngClass]="getPriorityClass(task.priority)">
          {{task.priority}}
        </span>
      </td>
    </ng-container>
    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
      <td mat-cell *matCellDef="let task">
        <span class="status-badge" [ngClass]="getStatusClass(task.status)">
          {{task.status}}
        </span>
      </td>
    </ng-container>
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>
        <div class="actions-header">
          <span>Actions</span>
          <button mat-icon-button [matMenuTriggerFor]="sortMenu" class="sort-button">
            <mat-icon>sort</mat-icon>
          </button>
          <mat-menu #sortMenu="matMenu">
            <button mat-menu-item (click)="loadAllTasks()">
              <mat-icon>list</mat-icon>
              All Tasks
            </button>
            <button mat-menu-item (click)="loadTasksDueInNext7Days()">
              <mat-icon>schedule</mat-icon>
              Due in Next 7 Days
            </button>
            <button mat-menu-item (click)="loadOverdueTasks()">
              <mat-icon>warning</mat-icon>
              Overdue Tasks
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="sortByPriority('high')">
              <mat-icon>priority_high</mat-icon>
              Priority: High to Low
            </button>
            <button mat-menu-item (click)="sortByPriority('low')">
              <mat-icon>priority_low</mat-icon>
              Priority: Low to High
            </button>
          </mat-menu>
        </div>
      </th>
             <td mat-cell *matCellDef="let task">
         <button mat-icon-button [routerLink]="[task.id]">
           <mat-icon>edit</mat-icon>
         </button>
         <button mat-icon-button color="warn" (click)="deleteTask(task.id!)" [disabled]="!task.id">
           <mat-icon>delete</mat-icon>
         </button>
       </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>

  <!-- Mobile Card Layout -->
  <div class="mobile-task-cards">
    <div *ngIf="tasks.length === 0" class="mobile-no-tasks">
      <p>No tasks found. Create your first task using the + button!</p>
    </div>
    <div class="mobile-task-card" *ngFor="let task of tasks">
      <div class="mobile-task-header">
        <mat-checkbox
          class="mobile-task-checkbox"
          (click)="$event.stopPropagation()"
          (change)="$event ? toggleTaskSelection(task.id) : null"
          [checked]="isTaskSelected(task.id)">
        </mat-checkbox>
        <div class="mobile-task-title">{{task.title}}</div>
                 <div class="mobile-task-actions">
           <button mat-icon-button [routerLink]="[task.id]">
             <mat-icon>edit</mat-icon>
           </button>
           <button mat-icon-button color="warn" (click)="deleteTask(task.id!)" [disabled]="!task.id">
             <mat-icon>delete</mat-icon>
           </button>
         </div>
      </div>
      
      <div class="mobile-task-details">
        <div class="mobile-task-detail">
          <div class="mobile-task-label">Due Date</div>
          <div class="mobile-task-value">{{task.dueDate | date}}</div>
        </div>
        <div class="mobile-task-detail">
          <div class="mobile-task-label">Priority</div>
          <div class="mobile-task-badges">
            <span class="mobile-task-badge priority-badge" [ngClass]="getPriorityClass(task.priority)">
              {{task.priority}}
            </span>
          </div>
        </div>
        <div class="mobile-task-detail">
          <div class="mobile-task-label">Status</div>
          <div class="mobile-task-badges">
            <span class="mobile-task-badge status-badge" [ngClass]="getStatusClass(task.status)">
              {{task.status}}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <mat-paginator 
    [pageSizeOptions]="[5, 10, 25, 50]" 
    [pageSize]="10"
    showFirstLastButtons
    aria-label="Select page of tasks">
  </mat-paginator>

  <button mat-fab color="primary" class="fab-button" routerLink="new">
    <mat-icon>add</mat-icon>
  </button>
</div>

<!-- Bulk Update Status Dialog Template -->
<ng-template #bulkUpdateStatusDialog>
  <h2 mat-dialog-title>Update Status</h2>
  <mat-dialog-content>
    <p class="summary-text">You're updating {{ bulkDialogData.taskCount }} task(s).</p>
    
    <form [formGroup]="bulkStatusForm">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Status</mat-label>
        <mat-select formControlName="status" required>
          <mat-option value="Pending">Pending</mat-option>
          <mat-option value="InProgress">In Progress</mat-option>
          <mat-option value="Completed">Completed</mat-option>
        </mat-select>
      </mat-form-field>
    </form>

    <div *ngIf="bulkDialogError" class="error-message">
      {{ bulkDialogError }}
    </div>
  </mat-dialog-content>
  
  <mat-dialog-actions align="end">
    <button mat-button (click)="cancelBulkUpdate()" [disabled]="isBulkUpdating">Cancel</button>
    <button 
      mat-raised-button 
      color="primary" 
      (click)="confirmBulkUpdate()" 
      [disabled]="!bulkStatusForm.valid || isBulkUpdating">
      <mat-spinner *ngIf="isBulkUpdating" diameter="16" class="spinner"></mat-spinner>
      {{ isBulkUpdating ? 'Updating...' : 'Update' }}
    </button>
  </mat-dialog-actions>
</ng-template>
